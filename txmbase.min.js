var TXMBase=function(m,n,o,s){if(void 0===m)throw new Error("TXMBase requires jQuery 1.9+.");if(void 0===n)throw new Error("TXMBase requires Mustache.");if(void 0===o)throw new Error("TXMBase requires ObservableSlim 0.0.2+.");var a=0,i=[],r=[],l=function(e){-1===i.indexOf(e.instanceId)&&(r.push(e.instanceId),i.push(e.refresh));var t=i.length;setTimeout(function(){if(t==i.length){for(var e=i.length;e--;)i.pop()();r.length=0}},10)},d=function(e){var t=document.getElementById(e);if(!t)throw new Error("TXMBase::_getTemplate() could not find the template with element ID: '"+e+"'.");return t.innerHTML.trim()},c=function(e,t,i,n){var h=this;if(void 0===n)n={};var s={};if(m.extend(!0,s,t.data,i),m.extend(!0,i,s),this.options=m.extend(!0,{},t,n,{data:i}),this.className=e,this.baseClassInstance=a++,this.jqDom=null,this.initialized=!1,this.initList=this.options.initList||[],this.showLoadMask=this.options.showLoadMask||function(){return null},this.hideLoadMask=this.options.hideLoadMask||function(){return null},this.pendingInit=!1,this.pendingFetchCount=0,this.initRendered=!1,this.delayRefresh=!1,this._cleanUpChildren=null,this.childComponents={default:[]},this._refreshList=[],this.templates={},this.options.templates instanceof Array){if(0==this.options.templates.length)throw new Error("TXMBase::constructor cannot continue -- no templates provided.");for(var r=0;r<this.options.templates.length;r++)this.templates[this.options.templates[r]]=d(this.options.templates[r])}else this.templates=this.options.templates;if("string"==typeof this.options.loadingTemplate?document.getElementById(this.options.loadingTemplate)?this.loadingTemplate=d(this.options.loadingTemplate):this.loadingTemplate=this.options.loadingTemplate:this.loadingTemplate="<div></div>",this.uiBindings=this.options.uiBindings||{},this.dataBindings=this.options.dataBindings||{},"object"!=typeof i)throw new Error("TXMBase::constructor cannot continue. Missing argument 'data'. The 'data' argument is required and must contain a full definition of the component model data.");this._data=i,this.data=o.create(this._data,!1,function(e){if(1==h.initialized){for(var t=!1,i=[],n=e.length;n--;){for(var s in h.uiBindings){var r=!1;if("/"===s.charAt(0)&&"/"===s.charAt(s.length-1))r=new RegExp(s.substring(1,s.length-1)).test(e[n].currentPath);!0===h._refreshList||s!=e[n].currentPath&&!r||(!0===h.uiBindings[s]?h._refreshList=!0:h._refreshList=h._refreshList.concat(h.uiBindings[s]))}for(var o in h.dataBindings){r=!1;if("/"===o.charAt(0)&&"/"===o.charAt(o.length-1))r=new RegExp(o.substring(1,o.length-1)).test(e[n].currentPath);if(o==e[n].currentPath||r){1==h.dataBindings[o].delayRefresh&&(t=!0);i=i.concat(h.dataBindings[o].methods)}}}h._fetch(t,i),(!0===h._refreshList||0<h._refreshList.length)&&(h.pendingRefresh=!0,l({instanceId:h.baseClassInstance,refresh:function(){h._refresh()}}))}}),c.prototype.observe=function(e){return o.create(this._data,!0,e)},0==(this.options.delayInit||!1)&&this.init()};return c.prototype.init=function(){for(var n=this,e=[],t=[],i=0;i<this.initList.length;i++)if("function"!=typeof this.initList[i].condition||0!=this.initList[i].condition()){var s=new Promise(function(i){return function(e,t){n[n.initList[i].method](e,t)}}(i)).catch(function(t){return function(e){throw console.error(e),new Error("TXMBase::init cannot continue, "+n.className+"."+n.initList[t].method+"() failed to resolve. Error: "+e)}}(i));1==this.initList[i].preventRender?e.push(s):t.push(s)}0<e.length?(this.pendingFetchCount++,this.pendingInit=!0,Promise.all(e).then(function(){n.initialized=!0,n.pendingInit=!1,n._refreshList=!0,n.pendingRefresh=!0,l({instanceId:n.baseClassInstance,refresh:function(){n._refresh()}}),"function"==typeof n._init&&n._init(),n.pendingFetchCount--}).catch(function(e){console.error(e)})):(this.initialized=!0,"function"==typeof n._init&&n._init()),0<t.length&&(this.pendingFetchCount++,Promise.all(t).then(function(){n.pendingFetchCount--}).catch(function(e){console.error(e)}))},c.prototype._fetch=function(e,n){var s=this,t=!1;if(1==e&&0<n.length&&(this.delayRefresh=e,this.showLoadMask(),t=!0),0<n.length){this.pendingFetchCount++;for(var i=[],r=n.length;r--;){var o=new Promise(function(i){return function(e,t){if("function"!=typeof s[n[i]])throw new Error("TXMBase::_fetch cannot continue, the method "+s.className+"."+n[i]+"() does not exist or is not a function.");s[n[i]](e,t)}}(r)).catch(function(t){return function(e){throw console.error(e),new Error("An error occured in the "+s.className+"."+n[t]+"() method.")}}(r));i.push(o)}Promise.all(i).then(function(){s.delayRefresh=!1,1==t&&s.hideLoadMask(),(1==s._refreshList||0<s._refreshList.length)&&l({instanceId:s.baseClassInstance,refresh:function(){s._refresh()}}),s.pendingFetchCount--}).catch(function(e){console.error(e)})}},c.prototype.render=function(){if(0==this.initialized&&0==this.pendingInit&&this.init(),0==this.initialized&&1==this.pendingInit)if("function"==typeof this._renderLoading)var e=this._renderLoading();else e=m(n.render(this.loadingTemplate,null));else if(this._refreshList instanceof Array&&0==this._refreshList.length&&1==this.initRendered)e=this.jqDom;else{if(!(0<(e=this._render()).length&&e instanceof m&&e[0]instanceof s))throw new Error(this.className+".render() cannot continue. Component ._render() method must return a jQuery-referenced DOM element. Example: $('<div>hello world</div>');");for(var t=this._insertChildren(e),i=t.length;i--;)t[i].comp.jqDom=t[i].elmt;this.initRendered=!0}return this.jqDom=e},c.prototype._renderWithChildren=function(){if(0==this.initialized&&0==this.pendingInit&&this.init(),0==this.initialized&&1==this.pendingInit)if("function"==typeof this._renderLoading)var e=this._renderLoading();else e=m(n.render(this.loadingTemplate,null));else{if(!(0<(e=this._render()).length&&e instanceof m&&e[0]instanceof s))throw new Error(this.className+"._renderWithChildren() cannot continue. Component ._render() method must return a jQuery-referenced DOM element. Example: $('<div>hello world</div>');");var t=this._insertChildren(e)}return{elmt:e,insertedChildren:t}},c.prototype._render=function(){for(var e in this.templates)break;return m(n.render(this.templates[e],this.data))},c.prototype._insertChildren=function(e){var t=[];for(var i in this.childComponents)if("default"!==i){var n=[],s=e.find(i);if(0===s.length&&(s=e.find("table[is='"+i+"'], tbody[is='"+i+"'], select[is='"+i+"'], ul[is='"+i+"'], ol[is='"+i+"']")),1===s.length){for(var r=this.childComponents[i],o=0;o<r.length;o++){for(var h=s.clone(),a=r[o],l=0;l<a.length;l++){var d=a[l],c=h.find(d.options.tagName);if(0===c.length)h.find("tbody, tr, td, li, option").each(function(e,t){var i=m(t);if(i.attr("is")===d.options.tagName)return(c=i).removeAttr("is"),!1});if(1===c.length){var f=d._renderWithChildren();t.push({comp:d,elmt:f.elmt}),t.push.apply(t,f.insertedChildren),c.replaceWith(f.elmt)}else if(1<c.length)throw new Error("TXMBase::_insertChildren() cannot continue. Found multiple <"+d.options.tagName+"> tags. A repeatable section must not contain duplicate child tags.")}n.push(h.contents())}s.attr("is")===i?(s.html(""),s.removeAttr("is"),s.append(n)):s.replaceWith(n)}else if(1<s.length)throw new Error("TXMBase::_insertChildren() cannot continue. Found multiple <"+i+"> tags. A repeatable section must have one insertion target (i.e., one matching custom tag).")}for(var p=this.childComponents.default.length;p--;){var u=e.find(this.childComponents.default[p].options.tagName);if(1===u.length){f=this.childComponents.default[p]._renderWithChildren();t.push({comp:this.childComponents.default[p],elmt:f.elmt}),t.push.apply(t,f.insertedChildren),u.replaceWith(f.elmt)}else if(1<u.length)throw new Error("TXMBase::_insertChildren() cannot continue. Found multiple <"+this.childComponents.default[p].options.tagName+"> tags. A child component must match exactly one tag in the parent component. If you require instances of the same child component, use a repeatable section or provide each instance a unique tag name via the options.")}return t},c.prototype.refresh=function(){var e=this;this.pendingRefresh=!0,this._refreshList=!0,l({instanceId:e.baseClassInstance,refresh:function(){e._refresh()}})},c.prototype._refresh=function(){var n=this;if(1==this.initialized&&0==this.delayRefresh)if(null===this.jqDom)this.render();else{if("object"==typeof this._refreshList&&0<this._refreshList.length){if(this._refreshList=this._refreshList.filter(function(e,t){return n._refreshList.indexOf(e)==t}),1<this._refreshList.length)for(var e=this._refreshList.length;e--;)for(var t=this.jqDom.find(this._refreshList[e])[0],i=this._refreshList.length;i--;){if(e!==i)if(this.jqDom.find(this._refreshList[i])[0].contains(t)){this._refreshList.splice(e,1);break}}for(var s=this._renderWithChildren(),r=s.elmt,o=s.insertedChildren,h=this._refreshList.length;h--;){var a=this.jqDom.find(this._refreshList[h]),l=r.find(this._refreshList[h]);if(1<a.length||1<l.length)throw new Error("TXMBase::refresh() cannot continue. Refresh selector has multiple targets.");a.replaceWith(l)}for(h=o.length;h--;)this.jqDom[0].contains(o[h].elmt[0])&&(o[h].comp.jqDom=o[h].elmt);this._refreshList=[]}else if(1==this._refreshList){var d=this.jqDom;r=this.render();d.replaceWith(r),this._refreshList=[],"function"==typeof this._postRefresh&&this._postRefresh(!0,d)}this._cleanUpChildren=Math.floor(1e9*Math.random());var c=this._cleanUpChildren;setTimeout(function(){c==n._cleanUpChildren&&n.eachChildComponent(function(e,t,i){null!==e.jqDom&&n.jqDom[0].contains(e.jqDom[0])||i()})},500)}},c.prototype.eachChildComponent=function(e){var t=this;for(var i in this.childComponents)for(var n=this.childComponents[i].length;n--;)if("default"===i)e(this.childComponents[i][n],i,function(){t.childComponents[i][n].destroy(),t.childComponents[i].splice(n,1)});else for(var s=this.childComponents[i][n].length;s--;)e(this.childComponents[i][n][s],i,function(){t.childComponents[i][n][s].destroy(),t.childComponents[i][n].splice(s,1),0===t.childComponents[i][n].length&&t.childComponents[i].splice(n,1),0===t.childComponents[i].length&&delete t.childComponents[i]})},c.prototype.registerChild=function(e,t){if(void 0===t)t="default";else if(!(e instanceof Array))throw new Error("When registering child components in a repeatable section, the child components must be registered in an array with each registration representing one repetition of the section (e.g., this.registerChild([childA, childB], 'section-name');).");void 0===this.childComponents[t]&&(this.childComponents[t]=[]),-1===this.childComponents[t].indexOf(e)&&this.childComponents[t].push(e)},c.prototype.destroy=function(){this.eachChildComponent(function(e,t){e.destroy()}),this.childComponents={default:[]},o.remove(this.data),null!==this.jqDom&&this.jqDom.remove()},c.prototype.isReady=function(){var i=!0;return this.eachChildComponent(function(e,t){!1===e.isReady()&&(i=!1)}),!0===i&&0===this._refreshList.length&&0===this.pendingFetchCount&&!1===this.pendingInit},c};"undefined"==typeof module?window.TXMBase=TXMBase($,Mustache,ObservableSlim,HTMLElement):module.exports=function(e,t,i,n){return TXMBase(e,t,i,n)};