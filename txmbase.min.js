var TXMBase=function(r,e,a,n){if(void 0===r)throw new Error("TXMBase requires jQuery 1.9+.");if(void 0===e)throw new Error("TXMBase requires Mustache.");if(void 0===a)throw new Error("TXMBase requires ObservableSlim 0.0.2+.");var l=0,i=[],s=[],d=function(t){-1===i.indexOf(t.instanceId)&&(s.push(t.instanceId),i.push(t.refresh));var e=i.length;setTimeout(function(){if(e==i.length){for(var t=i.length;t--;)i.pop()();s.length=0}},10)},c=function(t){var e=document.getElementById(t);if(!e)throw new Error("TXMBase::_getTemplate() could not find the template with element ID: '"+t+"'.");return e.innerHTML.trim()},f=function(t,e,n,i){var h=this;if(void 0===i)i={};var s={};if(r.extend(!0,s,e.data,n),r.extend(!0,n,s),this.options=r.extend(!0,{},e,i,{data:n}),this.className=t,this.baseClassInstance=l++,this.jqDom=null,this.initialized=!1,this.initList=this.options.initList||[],this.showLoadMask=this.options.showLoadMask||function(){return null},this.hideLoadMask=this.options.hideLoadMask||function(){return null},this.pendingInit=!1,this.pendingFetchCount=0,this.initRendered=!1,this.delayRefresh=!1,this._cleanUpChildren=null,this.childComponents={default:[]},this._refreshList=[],this.templates={},this.options.templates instanceof Array){if(0==this.options.templates.length)throw new Error("TXMBase::constructor cannot continue -- no templates provided.");for(var o=0;o<this.options.templates.length;o++)this.templates[this.options.templates[o]]=c(this.options.templates[o])}else this.templates=this.options.templates;if("string"==typeof this.options.loadingTemplate?document.getElementById(this.options.loadingTemplate)?this.loadingTemplate=c(this.options.loadingTemplate):this.loadingTemplate=this.options.loadingTemplate:this.loadingTemplate="<div></div>",this.uiBindings=this.options.uiBindings||{},this.dataBindings=this.options.dataBindings||{},"object"!=typeof n)throw new Error("TXMBase::constructor cannot continue. Missing argument 'data'. The 'data' argument is required and must contain a full definition of the component model data.");this._data=n,this.data=a.create(this._data,!1,function(t){if(1==h.initialized){for(var e=!1,n=[],i=t.length;i--;){for(var s in h.uiBindings){var o=!1;if("/"===s.charAt(0)&&"/"===s.charAt(s.length-1))o=new RegExp(s.substring(1,s.length-1)).test(t[i].currentPath);!0===h._refreshList||s!=t[i].currentPath&&!o||(!0===h.uiBindings[s]?h._refreshList=!0:h._refreshList=h._refreshList.concat(h.uiBindings[s]))}for(var r in h.dataBindings){o=!1;if("/"===r.charAt(0)&&"/"===r.charAt(r.length-1))o=new RegExp(r.substring(1,r.length-1)).test(t[i].currentPath);if(r==t[i].currentPath||o){1==h.dataBindings[r].delayRefresh&&(e=!0);n=n.concat(h.dataBindings[r].methods)}}}h._fetch(e,n),(!0===h._refreshList||0<h._refreshList.length)&&(h.pendingRefresh=!0,d({instanceId:h.baseClassInstance,refresh:function(){h._refresh()}}))}}),f.prototype.observe=function(t){return a.create(this._data,!0,t)},0==(this.options.delayInit||!1)&&this.init()};return f.prototype.init=function(){for(var i=this,t=[],e=[],n=0;n<this.initList.length;n++)if("function"!=typeof this.initList[n].condition||0!=this.initList[n].condition()){var s=new Promise(function(n){return function(t,e){i[i.initList[n].method](t,e)}}(n)).catch(function(e){return function(t){throw console.error(t),new Error("TXMBase::init cannot continue, "+i.className+"."+i.initList[e].method+"() failed to resolve. Error: "+t)}}(n));1==this.initList[n].preventRender?t.push(s):e.push(s)}0<t.length?(this.pendingFetchCount++,this.pendingInit=!0,Promise.all(t).then(function(){i.initialized=!0,i.pendingInit=!1,i._refreshList=!0,i.pendingRefresh=!0,d({instanceId:i.baseClassInstance,refresh:function(){i._refresh()}}),"function"==typeof i._init&&i._init(),i.pendingFetchCount--}).catch(function(t){console.error(t)})):(this.initialized=!0,"function"==typeof i._init&&i._init()),0<e.length&&(this.pendingFetchCount++,Promise.all(e).then(function(){i.pendingFetchCount--}).catch(function(t){console.error(t)}))},f.prototype._fetch=function(t,i){var s=this,e=!1;if(1==t&&0<i.length&&(this.delayRefresh=t,this.showLoadMask(),e=!0),0<i.length){this.pendingFetchCount++;for(var n=[],o=i.length;o--;){var r=new Promise(function(n){return function(t,e){if("function"!=typeof s[i[n]])throw new Error("TXMBase::_fetch cannot continue, the method "+s.className+"."+i[n]+"() does not exist or is not a function.");s[i[n]](t,e)}}(o)).catch(function(e){return function(t){throw console.error(t),new Error("An error occured in the "+s.className+"."+i[e]+"() method.")}}(o));n.push(r)}Promise.all(n).then(function(){s.delayRefresh=!1,1==e&&s.hideLoadMask(),(1==s._refreshList||0<s._refreshList.length)&&d({instanceId:s.baseClassInstance,refresh:function(){s._refresh()}}),s.pendingFetchCount--}).catch(function(t){console.error(t)})}},f.prototype.render=function(){if(0==this.initialized&&0==this.pendingInit&&this.init(),0==this.initialized&&1==this.pendingInit)var t=r(e.render(this.loadingTemplate,null));else if(this._refreshList instanceof Array&&0==this._refreshList.length&&1==this.initRendered)t=this.jqDom;else{if(!(0<(t=this._render()).length&&t instanceof r&&t[0]instanceof n))throw new Error(this.className+".render() cannot continue. Component ._render() method must return a jQuery-referenced DOM element. Example: $('<div>hello world</div>');");this._insertChildren(t),this.initRendered=!0}return this.jqDom=t},f.prototype._render=function(){for(var t in this.templates)break;return r(e.render(this.templates[t],this.data))},f.prototype.refresh=function(){var t=this;this.pendingRefresh=!0,this._refreshList=!0,d({instanceId:t.baseClassInstance,refresh:function(){t._refresh()}})},f.prototype._refresh=function(){var i=this;if(1==this.initialized&&0==this.delayRefresh)if(null===this.jqDom)this.render();else{if("object"==typeof this._refreshList&&0<this._refreshList.length){this._refreshList=this._refreshList.filter(function(t,e){return i._refreshList.indexOf(t)==e});for(var t=this._render(),e=this._refreshList.length;e--;){var n=this.jqDom.find(this._refreshList[e]),s=t.find(this._refreshList[e]);if(1<n.length||1<s.length)throw new Error("TXMBase::refresh() cannot continue. Refresh selector has multiple targets.");n.replaceWith(s)}this._insertChildren(this.jqDom),this._refreshList=[]}else if(1==this._refreshList){var o=this.jqDom;t=this.render();o.replaceWith(t),this._refreshList=[]}this._cleanUpChildren=Math.floor(1e9*Math.random());var r=this._cleanUpChildren;setTimeout(function(){r==i._cleanUpChildren&&i._eachChildComponent(function(t,e,n){null!==e.jqDom&&i.jqDom[0].contains(e.jqDom[0])||n()})},500)}},f.prototype._insertChildren=function(t){for(var e in this.childComponents)if("default"!==e){for(var n=[],i=t.find(e),s=this.childComponents[e],o=s.length;o--;){for(var r=i.clone(),h=s[o],a=h.length;a--;){var l=h[a];r.find(l.options.tagName).replaceWith(l.render())}n.push(r.contents())}t.find(e).replaceWith(n)}for(var d=this.childComponents.default.length;d--;)t.find(this.childComponents.default[d].options.tagName).replaceWith(this.childComponents.default[d].render())},f.prototype._eachChildComponent=function(t){var e=this;for(var n in this.childComponents)for(var i=this.childComponents[n].length;i--;)if("default"===n)t(n,this.childComponents[n][i],function(){e.childComponents[n][i].destroy(),e.childComponents[n].splice(i,1)});else for(var s=this.childComponents[n][i].length;s--;)t(n,this.childComponents[n][i][s],function(){e.childComponents[n][i][s].destroy(),e.childComponents[n][i].splice(s,1),0===e.childComponents[n][i].length&&e.childComponents[n].splice(i,1),0===e.childComponents[n].length&&delete e.childComponents[n]})},f.prototype.registerChild=function(t,e){void 0===e&&(e="default"),void 0===this.childComponents[e]&&(this.childComponents[e]=[]),-1===this.childComponents[e].indexOf(t)&&this.childComponents[e].push(t)},f.prototype.destroy=function(){this._eachChildComponent(function(t,e){e.destroy()}),this.childComponents={default:[]},a.remove(this.data),null!==this.jqDom&&this.jqDom.remove()},f.prototype.isReady=function(){var n=!0;return this._eachChildComponent(function(t,e){!1===e.isReady()&&(n=!1)}),!0===n&&0===this._refreshList.length&&0===this.pendingFetchCount&&!1===this.pendingInit},f};"undefined"==typeof module?window.TXMBase=TXMBase($,Mustache,ObservableSlim,HTMLElement):module.exports=function(t,e,n,i){return TXMBase(t,e,n,i)};