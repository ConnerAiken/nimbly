var TXMBase=function(r,e,o){if("undefined"==typeof document)throw new Error("TXMBase requires a document.");if(void 0===r)throw new Error("TXMBase requires jQuery 1.9+.");if(void 0===e)throw new Error("TXMBase requires Mustache.");if(void 0===o)throw new Error("TXMBase requires ObservableSlim 0.0.2+.");var a=0,i=[],n=[],d=function(t){-1==i.indexOf(t.instanceId)&&(n.push(t.instanceId),i.push(t.refresh));var e=i.length;setTimeout(function(){if(e==i.length){for(var t=i.length;t--;)i.pop()();n.length=0}},10)},f=function(t){var e=document.getElementById(t);if(!e)throw new Error("TXMBase::_getTemplate() could not find the template with element ID: '"+t+"'.");return e.innerHTML.trim()},c=function(t,e,i,n){var h=this;if(void 0===n)n={};if(e.data=r.extend(e.data,i),i=r.extend(i,e.data),this.options=r.extend(!0,{},e,n),this.className=t,this.baseClassInstance=a++,this.jqDom=null,this.initialized=!1,this.initList=this.options.initList||[],this.showLoadMask=this.options.showLoadMask||function(){return null},this.hideLoadMask=this.options.hideLoadMask||function(){return null},this.pendingInit=!1,this.pendingFetchCount=0,this.initRendered=!1,this.delayRefresh=!1,this._excludeRefresh=!1,this._cleanUpChildren=null,this.childComponents=[],this.templates={},this._refreshList=[],0==this.options.templates.length)throw new Error("TXMBase::constructor cannot continue -- no templates provided.");for(var s=0;s<this.options.templates.length;s++)this.templates[this.options.templates[s]]=f(this.options.templates[s]);if("string"==typeof this.options.loadingTemplate?this.loadingTemplate=f(this.options.loadingTemplate):this.loadingTemplate="<div>loading</div>",this.uiBindings=this.options.uiBindings||{},this.dataBindings=this.options.dataBindings||{},"object"!=typeof i)throw new Error("TXMBase::constructor cannot continue. Missing argument 'data'. The 'data' argument is required and must contain a full definition of the component model data.");this._data=i,this.data=o.create(this._data,!1,function(t){if(1==h.initialized){for(var e=!1,i=[],n=t.length;n--;){for(var s in h.uiBindings){var r=!1;if("/"===s.charAt(0)&&"/"===s.charAt(s.length-1))r=new RegExp(s.substring(1,s.length-1)).test(t[n].currentPath);!0===h._refreshList||s!=t[n].currentPath&&!r||(!0===h.uiBindings[s]?h._refreshList=!0:h._refreshList=h._refreshList.concat(h.uiBindings[s]))}for(var o in h.dataBindings){r=!1;if("/"===o.charAt(0)&&"/"===o.charAt(o.length-1))r=new RegExp(o.substring(1,o.length-1)).test(t[n].currentPath);if(o==t[n].currentPath||r){1==h.dataBindings[o].delayRefresh&&(e=!0);i=i.concat(h.dataBindings[o].methods)}}}h._fetch(e,i),(!0===h._refreshList||0<h._refreshList.length)&&(h.pendingRefresh=!0,d({instanceId:h.baseClassInstance,refresh:function(){h._refresh()}}))}}),c.prototype.observe=function(t){return o.create(this._data,!0,t)},0==(this.options.delayInit||!1)&&this.init()};return c.prototype.init=function(){for(var n=this,t=[],e=[],i=0;i<this.initList.length;i++)if("function"!=typeof this.initList[i].condition||0!=this.initList[i].condition()){var s=new Promise(function(i){return function(t,e){n[n.initList[i].method](t,e)}}(i)).catch(function(e){return function(t){throw console.error(t),new Error("TXMBase::init cannot continue, "+n.className+"."+n.initList[e].method+"() failed to resolve. Error: "+t)}}(i));1==this.initList[i].preventRender?t.push(s):e.push(s)}0<t.length?(this.pendingFetchCount++,this.pendingInit=!0,Promise.all(t).then(function(){n.initialized=!0,n.pendingInit=!1,n._refreshList=!0,n.pendingRefresh=!0,d({instanceId:n.baseClassInstance,refresh:function(){n._refresh()}}),"function"==typeof n._init&&n._init(),n.pendingFetchCount--}).catch(function(t){console.error(t)})):(this.initialized=!0,"function"==typeof n._init&&n._init()),0<e.length&&(this.pendingFetchCount++,Promise.all(e).then(function(){n.pendingFetchCount--}).catch(function(t){console.error(t)}))},c.prototype._fetch=function(t,n){var s=this,e=!1;if(1==t&&0<n.length&&(this.delayRefresh=t,this.showLoadMask(),e=!0),0<n.length){this.pendingFetchCount++;for(var i=[],r=n.length;r--;){var o=new Promise(function(i){return function(t,e){if("function"!=typeof s[n[i]])throw new Error("TXMBase::_fetch cannot continue, the method "+s.className+"."+n[i]+"() does not exist or is not a function.");s[n[i]](t,e)}}(r)).catch(function(e){return function(t){throw console.error(t),new Error("An error occured in the "+s.className+"."+n[e]+"() method.")}}(r));i.push(o)}Promise.all(i).then(function(){s.delayRefresh=!1,1==e&&s.hideLoadMask(),(1==s._refreshList||0<s._refreshList.length)&&d({instanceId:s.baseClassInstance,refresh:function(){s._refresh()}}),s.pendingFetchCount--}).catch(function(t){console.error(t)})}},c.prototype.render=function(){if(!1===this._excludeRefresh){if(0==this.initialized&&0==this.pendingInit&&this.init(),0==this.initialized&&1==this.pendingInit)var t=r(e.render(this.loadingTemplate,null));else if(this._refreshList instanceof Array&&0==this._refreshList.length&&1==this.initRendered)t=this.jqDom;else{t=this._render();this.initRendered=!0}this.jqDom=t}else t=r("<div>Exclude from render</div>");return t},c.prototype._render=function(){return r(e.render(this.templates[0],this.data))},c.prototype.notifyChange=function(t,e){if("object"!=typeof t)throw new Error("TXMBase::notifyChange() cannot continue -- dataObj must be an object.");if("string"!=typeof e)throw new Error("TXMBase::notifyChange() cannot continue -- dataObj must be a string.");var i=t[e];t[e]=null,t[e]=i},c.prototype.refresh=function(){this.pendingRefresh=!0,this._refreshList=!0,d({instanceId:self.baseClassInstance,refresh:function(){self._refresh()}})},c.prototype._refresh=function(){var i=this;if(1==this.initialized&&0==this.delayRefresh)if(null===this.jqDom)this.render();else{if("object"==typeof this._refreshList&&0<this._refreshList.length){this._refreshList=this._refreshList.filter(function(t,e){return i._refreshList.indexOf(t)==e});for(var t=this.childComponents.length;t--;){this.childComponents[t]._excludeRefresh=!0;for(var e=this._refreshList.length;e--;){var n=this.jqDom.find(this._refreshList[e]);if(0<n.length&&n[0].contains(this.childComponents[t].jqDom[0])){this.childComponents[t]._excludeRefresh=!1;break}}}for(var s=this._render(),r=this._refreshList.length;r--;){var o=this.jqDom.find(this._refreshList[r]),h=s.find(this._refreshList[r]);if(1<o.length||1<h.length){console.error("TXMBase::refresh() cannot continue. Refresh selector has multiple targets.");break}o.replaceWith(h)}for(r=this.childComponents.length;r--;)this.childComponents[r]._excludeRefresh=!1;this._refreshList=[]}else if(1==this._refreshList){var a=this.jqDom;s=this.render();a.replaceWith(s),this.jqDom=s,this._refreshList=[]}this._cleanUpChildren=Math.floor(1e9*Math.random());var d=this._cleanUpChildren;setTimeout(function(){if(d==i._cleanUpChildren)for(var t=i.childComponents.length;t--;)null!==i.childComponents[t].jqDom&&i.jqDom[0].contains(i.childComponents[t].jqDom[0])||(i.childComponents[t].destroy(),i.childComponents.splice(t,1))},7e3)}},c.prototype.registerChild=function(t){if("object"!=typeof t||t.init!==this.init||t.render!==this.render||t.destroy!==this.destroy)throw new Error("TXMBase::registerChild() cannot continue -- childComponent is not a valid component.");this.childComponents.push(t)},c.prototype.destroy=function(){for(var t=this.childComponents.length;t--;)this.childComponents[t].destroy();o.remove(this.data),null!==this.jqDom&&this.jqDom.remove()},c.prototype.isReady=function(){for(var t=this.childComponents.length;t--;)if(!1===this.childComponents[t].isReady())return!1;return 0===this._refreshList.length&&0===this.pendingFetchCount&&!1===this.pendingInit},c};"undefined"==typeof module?window.TXMBase=TXMBase($,Mustache,ObservableSlim):module.exports=function(t,e,i){return TXMBase(t,e,i)};